# å¦‚ä½•è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼ç¼“å­˜ç³»ç»Ÿï¼Ÿ

## ä¸€ã€ç¼“å­˜æ¦‚è¿°

å¯¹äº**ç¼“å­˜**ï¼Œç›¸ä¿¡å¤§å®¶å·²ç»ååˆ†ç†Ÿæ‚‰äº†ï¼Œåœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨åˆ°ç¼“å­˜ã€‚ä½†å¯¹äºç¼“å­˜ï¼Œè¿™ä¸ªçœ‹ä¼¼ç®€å•çš„ä¸œè¥¿ï¼Œä½ çœŸçš„äº†è§£å®ƒå—ï¼Ÿ

### 1.1 ä»€ä¹ˆæ˜¯ç¼“å­˜ï¼Ÿ

ç¼“å­˜æ˜¯ä¸€ç§ç”¨äºå­˜å‚¨`ä¸´æ—¶æ•°æ®`çš„`é«˜é€Ÿ`æ•°æ®å­˜å‚¨å±‚ï¼Œé€šè¿‡å°†é¢‘ç¹è®¿é—®çš„æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ¥`æé«˜æ•°æ®è®¿é—®æ€§èƒ½`ã€‚åœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œç¼“å­˜æ— å¤„ä¸åœ¨ï¼Œä»
CPU çš„å¤šçº§ç¼“å­˜ï¼Œåˆ°æ“ä½œç³»ç»Ÿçš„`é¡µç¼“å­˜`ï¼Œåˆ°æµè§ˆå™¨çš„é¡µé¢ç¼“å­˜ï¼Œå†åˆ°åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ•°æ®ç¼“å­˜ï¼Œéƒ½åœ¨å‘æŒ¥ç€é‡è¦ä½œç”¨ã€‚

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜ï¼Ÿ

- **æå‡æ€§èƒ½**ï¼šé€šè¿‡å°†çƒ­ç‚¹æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œé¿å…é¢‘ç¹è®¿é—®æ•°æ®åº“æˆ–ç£ç›˜ï¼Œæ˜¾è‘—æé«˜æ•°æ®è®¿é—®é€Ÿåº¦ã€‚
- **å‡è½»æ•°æ®åº“å‹åŠ›**ï¼šé™ä½æ•°æ®åº“çš„è®¿é—®è´Ÿè½½ï¼Œæé«˜ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚
- **æé«˜ç³»ç»Ÿå¯ç”¨æ€§**ï¼šå½“æ•°æ®åº“å‡ºç°æ•…éšœæ—¶ï¼Œç¼“å­˜å¯ä»¥ä½œä¸ºä¸´æ—¶çš„æ•°æ®æºï¼Œä¿è¯ç³»ç»Ÿçš„åŸºæœ¬å¯ç”¨æ€§

æ ¹æœ¬åŸå› è¿˜æ˜¯ `CPUã€å†…å­˜ã€ç£ç›˜çš„è¯»å–é€Ÿåº¦å·®å¼‚å·¨å¤§`:

- CPU L1 ç¼“å­˜: ~1ns
- å†…å­˜: ~100ns
- SSD: ~0.1ms
- HDD: ~10ms

### 1.3 é€‚åˆä½¿ç”¨ç¼“å­˜çš„åœºæ™¯

æ—¢ç„¶ç¼“å­˜èƒ½å¤Ÿæå‡ç³»ç»Ÿæ€§èƒ½ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦å°±å¯ä»¥æ— è„‘åœ°ä½¿ç”¨ç¼“å­˜å‘¢ï¼Ÿè‚¯å®šä¸æ˜¯çš„ã€‚

ä»¥ä¸‹è¿™äº›åœºæ™¯æ‰é€‚åˆä½¿ç”¨ç¼“å­˜ï¼š

- **è¯»å¤šå†™å°‘çš„æ•°æ®**ï¼šå¦‚å•†å“ä¿¡æ¯ã€ç”¨æˆ·ä¿¡æ¯ç­‰ç›¸å¯¹ç¨³å®šçš„æ•°æ®ã€‚
- **è®¡ç®—å¤æ‚çš„æ•°æ®**ï¼šå¦‚ç»Ÿè®¡æ•°æ®ã€æ’è¡Œæ¦œç­‰éœ€è¦å¤§é‡è®¡ç®—çš„æ•°æ®ã€‚
- **é«˜å¹¶å‘è®¿é—®çš„æ•°æ®**ï¼šå¦‚çƒ­ç‚¹æ–°é—»ã€çƒ­é—¨å•†å“ç­‰ã€‚
- **åŸºç¡€æ•°æ®**ï¼šå¦‚å­—å…¸æ•°æ®ã€é…ç½®ä¿¡æ¯ç­‰å˜æ›´é¢‘ç‡ä½çš„æ•°æ®ã€‚

å¯¹äºæ•°æ®å®æ—¶æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯å¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼Œä½†å¦‚æœè¦æ±‚å®æ—¶æ€§å¾ˆé«˜ï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨æ•°æ®åº“ã€‚å› ä¸ºç°ä»£æ•°æ®åº“æ€§èƒ½å·²ç»è¶³å¤Ÿå¼ºå¤§ï¼Œè€Œå¼•å…¥ç¼“å­˜ä¼šå¢åŠ ç³»ç»Ÿå¤æ‚åº¦å’Œç»´æŠ¤æˆæœ¬ã€‚

### 1.4 Javaä¸­çš„ç¼“å­˜æ–¹æ¡ˆ

1.**æœ¬åœ°ç¼“å­˜**

- Map/ConcurrentHashMapï¼šæœ€ç®€å•çš„ç¼“å­˜å®ç°ï¼Œé€‚åˆå°è§„æ¨¡æ•°æ®ã€‚
- Guava Cacheï¼šGoogle å¼€æºçš„æœ¬åœ°ç¼“å­˜å®ç°
- EhCacheï¼šè€ç‰Œçš„ Java ç¼“å­˜æ¡†æ¶
- Caffeineï¼šé«˜æ€§èƒ½çš„æœ¬åœ°ç¼“å­˜åº“

2.**åˆ†å¸ƒå¼ç¼“å­˜**

- Redisï¼šæœ€æµè¡Œçš„åˆ†å¸ƒå¼ç¼“å­˜ç³»ç»Ÿ
- Memcachedï¼šé«˜æ€§èƒ½çš„åˆ†å¸ƒå¼å†…å­˜ç¼“å­˜ç³»ç»Ÿ

## äºŒã€Caffeine åŸç†è§£æ

`Caffeine` æ˜¯ç›®å‰ Java ä¸­æ€§èƒ½æœ€å¥½çš„æœ¬åœ°ç¼“å­˜æ–¹æ¡ˆï¼Œå®ƒåœ¨ `Guava Cache` çš„åŸºç¡€ä¸Šåšäº†å¤§é‡ä¼˜åŒ–ã€‚

### 2.1 Caffeine çš„è®¾è®¡æ€æƒ³

`Caffeine` çš„è®¾è®¡ç›®æ ‡æ˜¯åœ¨ä¿è¯`é«˜å¹¶å‘è¯»å†™` æ€§èƒ½çš„åŒæ—¶ï¼Œèƒ½å¤Ÿæœ€å¤§é™åº¦åœ°åˆ©ç”¨`å†…å­˜ç©ºé—´` ã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®æ ‡ï¼Œ`Caffeine`
åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢éƒ½åšäº†ç²¾å¿ƒçš„è®¾è®¡ï¼š

1. **ç¼“å­˜æ·˜æ±°ç®—æ³•çš„åˆ›æ–°**

    - ä¼ ç»Ÿçš„ **LRU**ï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç®—æ³•æ— æ³•å¾ˆå¥½åœ°å¤„ç†`æ‰«ææ±¡æŸ“`é—®é¢˜ã€‚
    - ä¼ ç»Ÿçš„ **LFU**ï¼ˆæœ€ä¸ç»å¸¸ä½¿ç”¨ï¼‰ç®—æ³•å¯¹`çªå‘æ€§çš„çƒ­ç‚¹æ•°æ®`æ”¯æŒä¸å¥½ã€‚
    - Caffeine åˆ›æ–°æ€§åœ°é‡‡ç”¨äº† **Window TinyLFU** ç®—æ³•ï¼Œç»“åˆäº† `LRU` å’Œ `LFU` çš„ä¼˜ç‚¹ã€‚

2. **å¹¶å‘ç¼–ç¨‹çš„ç²¾å¦™è®¾è®¡**

    - é‡‡ç”¨äº†`åˆ†æ®µé”æŠ€æœ¯`ï¼Œé™ä½é”ç²’åº¦ã€‚
    - ä½¿ç”¨`æ— é”ç¼–ç¨‹`æŠ€æœ¯ï¼Œå‡å°‘çº¿ç¨‹ç«äº‰ã€‚
    - ä¼˜åŒ–çš„å¼‚æ­¥å¤„ç†æœºåˆ¶ã€‚

ä¸‹é¢æ¥è¯¦è§£ä¸‹ `Caffeine`çš„`Window TinyLFU`ç®—æ³•ã€‚

### 2.2 Window TinyLFU ç®—æ³•è¯¦è§£

`Window TinyLFU` æ˜¯ `Caffeine` æ€§èƒ½ä¼˜åŒ–çš„å…³é”®æ‰€åœ¨ï¼Œå®ƒä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

2.2.1. **å‡†å…¥çª—å£ï¼ˆAdmission Windowï¼‰**

`å‡†å…¥çª—å£` çš„æœ¬è´¨æ˜¯ä¸€ä¸ª`å°å‹çš„ LRU ç¼“å­˜`ï¼Œç”¨äº`è¿‡æ»¤çªå‘æ€§çš„è®¿é—®`ï¼Œé¿å…å¯¹ä¸»ç¼“å­˜é€ æˆ`æ±¡æŸ“`ã€‚

   ```mermaid
   graph LR
       A[æ–°æ•°æ®] --> B[å‡†å…¥çª—å£<br>Window Cache<br>å æ¯” 1%]
       B --> C{é¢‘ç‡ç»Ÿè®¡}
       C -->|é¢‘ç‡é«˜| D[ä¸»ç¼“å­˜<br>Main Cache<br>å æ¯” 99%]
       C -->|é¢‘ç‡ä½| E[ä¸¢å¼ƒ]
       
       subgraph Window TinyLFU
           B
           C
           D
       end
   ```

**å·¥ä½œæµç¨‹ï¼š**

   ```mermaid
   sequenceDiagram
       participant Client as å®¢æˆ·ç«¯
       participant Window as å‡†å…¥çª—å£
       participant Sketch as é¢‘ç‡ç»Ÿè®¡å™¨
       participant Main as ä¸»ç¼“å­˜
       
       Client->>Window: 1. è¯·æ±‚æ•°æ®
       Window->>Sketch: 2. ç»Ÿè®¡è®¿é—®é¢‘ç‡
       Sketch->>Window: 3. è¿”å›é¢‘ç‡ä¿¡æ¯
       alt é¢‘ç‡é«˜äºé˜ˆå€¼
           Window->>Main: 4a. å…è®¸è¿›å…¥ä¸»ç¼“å­˜
       else é¢‘ç‡ä½äºé˜ˆå€¼
           Window->>Client: 4b. ç›´æ¥è¿”å›ï¼Œä¸è¿›å…¥ä¸»ç¼“å­˜
       end
   ```

2.2.2.**é¢‘ç‡ç»Ÿè®¡ï¼ˆFrequency Sketchï¼‰**

`Frequency Sketch` ä½¿ç”¨`Count-Min Sketch` æ•°æ®ç»“æ„æ¥è®°å½•è®¿é—®é¢‘ç‡ï¼Œè¿™æ˜¯ä¸€ä¸ª`æ¦‚ç‡å‹`æ•°æ®ç»“æ„ï¼Œç”¨`è¾ƒå°çš„ç©ºé—´å®ç°é¢‘ç‡ç»Ÿè®¡`ã€‚

```mermaid
   graph TD
       A[è®¿é—®è¯·æ±‚] --> B[è®¡ç®—å¤šä¸ªå“ˆå¸Œå€¼]
       B --> C[Count-Min SketchçŸ©é˜µ]
       
       subgraph Count-Min Sketch
       D[å“ˆå¸Œå‡½æ•°1] --> E[è®¡æ•°è¡Œ1]
       F[å“ˆå¸Œå‡½æ•°2] --> G[è®¡æ•°è¡Œ2]
       H[å“ˆå¸Œå‡½æ•°3] --> I[è®¡æ•°è¡Œ3]
       J[å“ˆå¸Œå‡½æ•°4] --> K[è®¡æ•°è¡Œ4]
       end
       
       C --> L[å–æœ€å°å€¼ä½œä¸ºä¼°è®¡é¢‘ç‡]
```

**Count-Min Sketch çš„å·¥ä½œåŸç†ï¼š**

```mermaid
   graph TB
       A[è¾“å…¥Key] --> B[è®¡ç®—å¤šä¸ªå“ˆå¸Œå€¼]
       B --> C[æ›´æ–°å¤šä¸ªè®¡æ•°å™¨]
       C --> D[å–æœ€å°å€¼ä½œä¸ºé¢‘ç‡]
       
       subgraph çŸ©é˜µç»“æ„
       E[4 x W çŸ©é˜µ]
       F[W = è®¡æ•°å™¨å®½åº¦]
       end
       
       subgraph è¡°å‡æœºåˆ¶
       G[å®šæœŸè¿›è¡Œè®¡æ•°å™¨è¡°å‡]
       H[æ‰€æœ‰è®¡æ•°å™¨å³ç§»1ä½]
       I[ä¿æŒå†å²æ•°æ®çš„æ—¶æ•ˆæ€§]
       end
```

2.2.3. **ä¼˜åŒ–çš„æ·˜æ±°ç­–ç•¥**

 ```mermaid
   graph TD
       A[ç¼“å­˜æ»¡] --> B{æ¯”è¾ƒé¢‘ç‡}
       B -->|æ–°æ•°æ®é¢‘ç‡æ›´é«˜| C[æ›¿æ¢æœ€æ—§æ•°æ®]
       B -->|æ–°æ•°æ®é¢‘ç‡æ›´ä½| D[æ‹’ç»æ–°æ•°æ®]
       
       subgraph é¢‘ç‡è®¡ç®—
       E[å®æ—¶é¢‘ç‡] --> F[å†å²é¢‘ç‡]
       F --> G[è¡°å‡å› å­]
       end
```

ç¤ºä¾‹å®ç°ä»£ç ï¼š

```java
public class FrequencySketch {
    private final long[] table;
    private final int[] seeds;
    private final int width;
    private final int rows;

    public FrequencySketch(int width, int rows) {
        this.table = new long[width * rows];
        this.seeds = new int[rows];
        this.width = width;
        this.rows = rows;
        // åˆå§‹åŒ–éšæœºç§å­
        Random random = new Random(1234);
        for (int i = 0; i < rows; i++) {
            seeds[i] = random.nextInt();
        }
    }

    public void increment(long item) {
        // æ›´æ–°æ‰€æœ‰è¡Œçš„è®¡æ•°å™¨
        for (int i = 0; i < rows; i++) {
            int index = indexOf(item, i);
            if (table[index] < Long.MAX_VALUE) {
                table[index]++;
            }
        }
    }

    public long frequency(long item) {
        // è·å–æœ€å°è®¡æ•°å€¼ä½œä¸ºä¼°è®¡é¢‘ç‡
        long min = Long.MAX_VALUE;
        for (int i = 0; i < rows; i++) {
            min = Math.min(min, table[indexOf(item, i)]);
        }
        return min;
    }

    private int indexOf(long item, int row) {
        // ä½¿ç”¨ä¸åŒçš„å“ˆå¸Œå‡½æ•°è®¡ç®—ç´¢å¼•
        long hash = item * seeds[row];
        hash += hash >>> 32;
        return ((int) hash & Integer.MAX_VALUE) % width + (row * width);
    }
}
```

### 2.3 é«˜å¹¶å‘è®¾è®¡

`Caffeine` åœ¨`å¹¶å‘å¤„ç†`ä¸Šä¹Ÿåšäº†å¤§é‡ä¼˜åŒ–ã€‚

2.3.1. **åˆ†æ®µé”è®¾è®¡**

```java
// ç®€åŒ–çš„åˆ†æ®µé”ç¤ºæ„
class StripedBuffer<K, V> {
    private final Object[] locks;
    private final Buffer<K, V>[] buffers;

    public void write(K key, V value) {
        int index = hash(key) % locks.length;
        synchronized (locks[index]) {
            buffers[index].put(key, value);
        }
    }
}
```

- é™ä½é”ç²’åº¦ï¼Œæé«˜å¹¶å‘æ€§
- å‡å°‘çº¿ç¨‹ç­‰å¾…æ—¶é—´
- ä¼˜åŒ–å†™å…¥æ€§èƒ½

2.3.2.**å¼‚æ­¥å¤„ç†æœºåˆ¶**

```java
// Caffeine å¼‚æ­¥åŠ è½½ç¤ºä¾‹
LoadingCache<Key, Graph> graphs = Caffeine.newBuilder()
                .maximumSize(10_000)
                // è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´  
                .expireAfterWrite(Duration.ofMinutes(5))
                // è®¾ç½®ç¼“å­˜åˆ·æ–°æ—¶é—´  
                .refreshAfterWrite(Duration.ofMinutes(1))
                .build(key -> createExpensiveGraph(key));
   ```

- æ”¯æŒå¼‚æ­¥åŠ è½½å’Œåˆ·æ–°
- éé˜»å¡çš„ç¼“å­˜æ“ä½œ
- æé«˜ç³»ç»Ÿååé‡

2.3.3.**å†™å…¥ç¼“å†²åŒºä¼˜åŒ–**

- ä½¿ç”¨ `BufferWriter` å‡å°‘é”ç«äº‰
- æ‰¹é‡å¤„ç†å†™å…¥è¯·æ±‚
- æé«˜å†™å…¥æ•ˆç‡

## ä¸‰ã€ç¼“å­˜é¢ä¸´çš„é—®é¢˜

è™½è¯´ç¼“å­˜èƒ½å¤Ÿæå‡ç³»ç»Ÿæ€§èƒ½ï¼Œä½†ä¸æ­¤åŒæ—¶ï¼Œä½¿ç”¨ç¼“å­˜ä¹ŸåŒæ ·ä¼šå¸¦æ¥å¾ˆå¤šé—®é¢˜ã€‚

### 3.1 ç¼“å­˜ä¸‰å¤§é—®é¢˜

ä¸‹é¢æ˜¯ç¼“å­˜çš„å‡ ä¸ªç»å…¸é—®é¢˜ï¼Œé¢è¯•ä¸­ä¹Ÿç»å¸¸ä¼šè¢«é—®åˆ°ï¼Œä¹Ÿç¡®å®æ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨ç¼“å­˜æ—¶éœ€è¦æ€è€ƒå’Œè§£å†³çš„é—®é¢˜ã€‚

1. **ç¼“å­˜å‡»ç©¿**

    - é—®é¢˜ï¼šçƒ­ç‚¹ key è¿‡æœŸå¯¼è‡´å¤§é‡è¯·æ±‚ç›´å‡»æ•°æ®åº“
    - è§£å†³ï¼šä½¿ç”¨åˆ†å¸ƒå¼é” + äºŒçº§ç¼“å­˜

2. **ç¼“å­˜é›ªå´©**

    - é—®é¢˜ï¼šå¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸ
    - è§£å†³ï¼šè¿‡æœŸæ—¶é—´éšæœºåŒ–ã€å¤šçº§ç¼“å­˜ã€ç†”æ–­é™çº§

3. **ç¼“å­˜ç©¿é€**

    - é—®é¢˜ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®å¯¼è‡´è¯·æ±‚ç›´å‡»æ•°æ®åº“
    - è§£å†³ï¼šå¸ƒéš†è¿‡æ»¤å™¨ã€ç©ºå€¼ç¼“å­˜

å‘ç°æ²¡æœ‰ï¼Œä¸Šè¿°é—®é¢˜ï¼Œå…¶å®éƒ½å¯ä»¥å°è¯•åœ¨æ•°æ®åº“å’Œæœ¬åœ°ç¼“å­˜ä¹‹é—´åŠ ä¸€å±‚ä¸­é—´å±‚æ¥è§£å†³ã€‚è¿™ä¹Ÿæ˜¯è½¯ä»¶æ¶æ„è®¾è®¡ä¸­çš„ä¸€ä¸ªå¸¸è§æ¨¡å¼ -
é€šè¿‡åˆ†å±‚æ¥åŒ–è§£å¤æ‚æ€§ã€‚å¦‚æœä¸€å±‚ä¸­é—´å±‚è§£å†³ä¸äº†ï¼Œé‚£å°±å†åŠ ä¸€å±‚ã€‚ğŸ¶

### 3.2 **ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜**

å…¶å®ï¼Œä¸ªäººè§‰å¾—ä½¿ç”¨ç¼“å­˜é¢ä¸´çš„æœ€æ ¸å¿ƒçš„é—®é¢˜ï¼Œå…¶å®æ˜¯ `ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜`ã€‚
è¿™é‡Œçš„ä¸€è‡´æ€§ï¼ŒæŒ‡çš„æ˜¯ç¼“å­˜å’Œæ•°æ®åº“é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼Œä»¥åŠå¤šä¸ªå®ä¾‹ä¹‹é—´æœ¬åœ°ç¼“å­˜çš„ä¸€è‡´æ€§ã€‚

æœ‰å“ªäº›åœºæ™¯å¯èƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼Ÿ

**å¸¸è§çš„ä¸€è‡´æ€§é—®é¢˜**

- æ›´æ–°æ•°æ®åº“åç¼“å­˜æœªåŠæ—¶æ›´æ–°ã€‚
- å¹¶å‘æ›´æ–°å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´ã€‚
- åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ•°æ®åŒæ­¥é—®é¢˜ï¼Œä¾‹å¦‚å¤šå®ä¾‹çš„æœ¬åœ°ç¼“å­˜ä¸ä¸€è‡´ã€‚

**è§£å†³æ–¹æ¡ˆ**

- å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜
- å»¶æ—¶åŒåˆ 
- æ¶ˆæ¯é˜Ÿåˆ—å®ç°æœ€ç»ˆä¸€è‡´æ€§
- åˆ†å¸ƒå¼é”ä¿è¯å¹¶å‘å®‰å…¨
- ç‰ˆæœ¬å·æœºåˆ¶

## å››ã€åˆ†å¸ƒå¼ç¼“å­˜æ¶æ„è®¾è®¡

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ¢è®¨åœ¨ä¸€ä¸ª`åˆ†å¸ƒå¼ç³»ç»Ÿ`ä¸­ï¼Œåº”è¯¥å¦‚ä½•æ¥è®¾è®¡æˆ‘ä»¬çš„ç¼“å­˜ç³»ç»Ÿï¼Œä»¥åŠå¦‚ä½•è§£å†³ä¸Šé¢æåˆ°çš„å„ç§é—®é¢˜ã€‚

### 4.1 å¤šçº§ç¼“å­˜æ¶æ„

```
åº”ç”¨å±‚
  â†“
æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰
  â†“
åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰
  â†“
æ•°æ®åº“
```

è¿™é‡Œä¸ºä»€ä¹ˆå¼•å…¥ `Redis` ä½œä¸ºåˆ†å¸ƒå¼ç¼“å­˜ä¸­é—´å±‚å‘¢ï¼Ÿç¨åä¼šè¯¦ç»†ä»‹ç»ã€‚

### 4.2 ç¼“å­˜æ›´æ–°ç­–ç•¥

å¸¸è§çš„ç¼“å­˜æ›´æ–°ç­–ç•¥æœ‰ï¼š

- **Cache Aside Pattern**
    - å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜
- **Read/Write Through Pattern**
    - å…ˆæ›´æ–°ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®æº
- **Write Behind Pattern**
    - å…ˆæ›´æ–°ç¼“å­˜ï¼Œå¼‚æ­¥æ›´æ–°æ•°æ®æº

è¿™é‡Œæˆ‘ä»¬é€‰æ‹©çš„æ˜¯ `Cache Aside Pattern-å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜`ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå…·ä½“çš„åœºæ™¯æ¥åˆ†æä¸‹ï¼š

1.**ä¸ºä»€ä¹ˆæ˜¯åˆ é™¤è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ**

- åˆ é™¤ç¼“å­˜çš„æ“ä½œæ¯”æ›´æ–°ç¼“å­˜æ›´ç®€å•ï¼Œä¸å®¹æ˜“å‡ºé”™ã€‚
- åˆ é™¤ç¼“å­˜åï¼Œåç»­è¯·æ±‚ä¼šé‡æ–°åŠ è½½æ•°æ®ï¼Œç¡®ä¿æ•°æ®çš„æ­£ç¡®æ€§ã€‚
- å¦‚æœæ›´æ–°ç¼“å­˜ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹å¯èƒ½ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚

2.**ä¸ºä»€ä¹ˆæ˜¯å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ï¼Ÿ**

```mermaid
  sequenceDiagram
   participant A as çº¿ç¨‹A
   participant B as çº¿ç¨‹B
   participant C as ç¼“å­˜
   participant D as æ•°æ®åº“
   
   A->>C: åˆ é™¤ç¼“å­˜
   B->>C: è¯»å–ç¼“å­˜(æœªå‘½ä¸­)
   B->>D: è¯»å–æ•°æ®åº“(è¯»åˆ°æ—§å€¼)
   A->>D: æ›´æ–°æ•°æ®åº“
   B->>C: æ›´æ–°ç¼“å­˜(å†™å…¥æ—§å€¼)
```

- å¦‚æœå…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¼šå‡ºç°é—®é¢˜ï¼š
    1. çº¿ç¨‹Aåˆ é™¤ç¼“å­˜
    2. çº¿ç¨‹Bè¯»å–ç¼“å­˜æœªå‘½ä¸­ï¼Œè¯»å–æ—§æ•°æ®
    3. çº¿ç¨‹Aæ›´æ–°æ•°æ®åº“
    4. çº¿ç¨‹Bå°†æ—§æ•°æ®å†™å…¥ç¼“å­˜
- æœ€ç»ˆç¼“å­˜ä¸­æ˜¯æ—§æ•°æ®ï¼Œé€ æˆæ•°æ®ä¸ä¸€è‡´ã€‚

3.**Cache Aside Pattern ç­–ç•¥æ˜¯å¦å­˜åœ¨å¹¶å‘é—®é¢˜ï¼Ÿ**

- ç†è®ºä¸Šå­˜åœ¨å¹¶å‘é—®é¢˜ï¼Œå¦‚ä¸‹å›¾ï¼Œä½†æ¦‚ç‡æå°ã€‚
- éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ‰ä¼šå‡ºç°é—®é¢˜ï¼š
    1. ç¼“å­˜åˆšå¥½å¤±æ•ˆ
    2. çº¿ç¨‹Aæ›´æ–°æ•°æ®åº“ï¼Œå°šæœªæäº¤äº‹åŠ¡ï¼Œæ­¤æ—¶çº¿ç¨‹Bè¯»å–æ—§æ•°æ®ã€‚
    3. çº¿ç¨‹Aæäº¤äº‹åŠ¡ï¼Œåˆ é™¤ç¼“å­˜ã€‚
    4. çº¿ç¨‹Bæ›´æ–°ç¼“å­˜
- å®é™…ä¸Šåœ¨é«˜å¹¶å‘åœºæ™¯ä¸­ï¼Œè¿™ä¸ªæ—¶é—´çª—å£ä¹Ÿéå¸¸å°ï¼Œå› ä¸ºä¸€èˆ¬ä»`å·²ç»è¯»å–åˆ°æ•°æ®`åˆ°`è®¾ç½®åˆ°ç¼“å­˜`è¿™ä¸ªé—´éš™å…¶å®éå¸¸çŸ­ï¼Œé™¤éåˆšå¥½
  `å› GCå¯¼è‡´STW` äº†ç­‰æç«¯æƒ…å†µã€‚

```mermaid
sequenceDiagram
   participant A as çº¿ç¨‹A
   participant B as çº¿ç¨‹B
   participant C as ç¼“å­˜
   participant D as æ•°æ®åº“
   
   A->>D: æ›´æ–°æ•°æ®åº“ï¼Œå°šæœªæäº¤äº‹åŠ¡
   B->>C: è¯»å–ç¼“å­˜ï¼Œç¼“å­˜æ°å¥½å¤±æ•ˆ
   B->>D: è¯»å–æ•°æ®åº“ï¼ˆè¯»å–æ—§å€¼ï¼‰
   A->>D: æäº¤äº‹åŠ¡
   A->>C: åˆ é™¤ç¼“å­˜
   B->>C: æ›´æ–°ï¼ˆæ—§å€¼ï¼‰åˆ°ç¼“å­˜
```

### 4.3 **å¦‚ä½•è§£å†³æç«¯æƒ…å†µä¸‹çš„å¹¶å‘é—®é¢˜ï¼Ÿ**

- **å»¶è¿ŸåŒåˆ **ï¼šåœ¨æ›´æ–°æ•°æ®åº“åï¼Œå»¶è¿Ÿä¸€æ®µæ—¶é—´å†æ¬¡åˆ é™¤ç¼“å­˜ï¼Œå¯ä»¥ä¿éšœç»è¿‡çŸ­æš‚æ—¶é—´åï¼Œç¼“å­˜ä¸­çš„æ•°æ®å’Œæ•°æ®åº“ä¸­çš„æ•°æ®ä¸€è‡´ã€‚

```java
    // ä¼ªä»£ç ç¤ºä¾‹
void updateData() {
    // 1. æ›´æ–°æ•°æ®åº“
    db.update(data);
    // 2. åˆ é™¤ç¼“å­˜
    cache.delete(key);
    // 3. å»¶è¿Ÿä¸€æ®µæ—¶é—´åå†æ¬¡åˆ é™¤ç¼“å­˜
    Thread.sleep(500);
    cache.delete(key);
}
   ```

- **ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—**ï¼šå°†ç¼“å­˜åˆ é™¤æ“ä½œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œã€‚

```java
// ä¼ªä»£ç ç¤ºä¾‹
void updateData() {
    // 1. æ›´æ–°æ•°æ®åº“
    db.update(data);
    // 2. å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—
    messageQueue.send(new CacheDeleteMessage(key));
}
   ```

### 4.4 **å¦‚ä½•ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è§£å†³æç«¯æƒ…å†µä¸‹çš„å¹¶å‘é—®é¢˜ï¼Ÿ**

> å»¶æ—¶åŒåˆ èƒ½è§£å†³æç«¯æƒ…å†µä¸‹çš„ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼Œå¯èƒ½å¾ˆå¤šåŒå­¦éƒ½å¬è¯´è¿‡ï¼Œä½†ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿå¯ä»¥ï¼Ÿ

1. å¼‚æ­¥å¤„ç†å’Œè§£è€¦ï¼š

- å½“æ•°æ®åº“å®Œæˆæ›´æ–°åï¼ˆ`äº‹åŠ¡æäº¤å`ï¼‰ï¼Œå°†`ç¼“å­˜åˆ é™¤` æ“ä½œä½œä¸ºä¸€æ¡æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚
- æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯äº†åˆ é™¤æ“ä½œçš„`é¡ºåºæ€§`ï¼ˆéœ€è¦ä½¿ç”¨é¡ºåºæ¶ˆè´¹ï¼‰ï¼Œå³ä½¿å­˜åœ¨å¤šä¸ªè¯·æ±‚å¯¹åŒä¸€æ¡æ•°æ®è¿›è¡Œæ“ä½œï¼Œæœ€ç»ˆçš„ç¼“å­˜çŠ¶æ€æ˜¯ä¸€è‡´çš„ã€‚

2. å»é‡å’Œå¹‚ç­‰æ€§ï¼š

- ç”±äºåˆ é™¤ç¼“å­˜çš„æ“ä½œæœ¬èº«å°±æ˜¯`å¹‚ç­‰`çš„ï¼Œæ‰€ä»¥å³ä¾¿æ¶ˆæ¯é˜Ÿåˆ—é‡å¤æ¶ˆè´¹ï¼Œä¹Ÿä¸ä¼šå¯¹ç»“æœäº§ç”Ÿå½±å“ã€‚

3. é‡è¯•æœºåˆ¶ï¼š

- å¦‚æœç”±äºæŸäº›å¼‚å¸¸ï¼Œåˆ é™¤ç¼“å­˜çš„æ“ä½œå¤±è´¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥æä¾›`é‡è¯•æœºåˆ¶`ï¼Œç¡®ä¿åˆ é™¤æ“ä½œæœ€ç»ˆå®Œæˆã€‚

4. å¹¶å‘åœºæ™¯çš„ä¸€è‡´æ€§ï¼š

- å³ä½¿åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œåŒä¸€æ¡æ•°æ®ï¼Œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—çš„å¼‚æ­¥ç‰¹æ€§ï¼Œå¯ä»¥ç¡®ä¿æ•°æ®åº“å’Œç¼“å­˜çš„çŠ¶æ€æœ€ç»ˆä¸€è‡´ã€‚

#### **æ¶ˆæ¯é˜Ÿåˆ—çš„å®ç°**

- æ¯æ¬¡æ•°æ®åº“æ›´æ–°å®Œæˆåå‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ã€‚
- æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥æŒ‰ç…§å…ˆåé¡ºåºå¤„ç†ç¼“å­˜çš„åˆ é™¤æ“ä½œï¼Œç¡®ä¿ç¼“å­˜æœ€ç»ˆçš„çŠ¶æ€ä¸€è‡´ã€‚

**æµç¨‹å›¾ï¼š**

```mermaid
   sequenceDiagram
    participant A as çº¿ç¨‹A
    participant B as çº¿ç¨‹B 
    participant DB as æ•°æ®åº“
    participant MQ as æ¶ˆæ¯é˜Ÿåˆ—
    participant Cache as ç¼“å­˜

    A->>DB: æ›´æ–°æ•°æ®åº“
    B->>DB: æ›´æ–°æ•°æ®åº“
    A->>MQ: å‘é€ç¼“å­˜åˆ é™¤æ¶ˆæ¯
    B->>MQ: å‘é€ç¼“å­˜åˆ é™¤æ¶ˆæ¯
    Note over MQ: æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯æ¶ˆæ¯é¡ºåºæ€§
    MQ->>Cache: æŒ‰é¡ºåºåˆ é™¤ç¼“å­˜
    MQ->>Cache: æŒ‰é¡ºåºåˆ é™¤ç¼“å­˜
    Note over Cache: æœ€ç»ˆç¼“å­˜çŠ¶æ€ä¸€è‡´
```

**æ¶ˆæ¯é˜Ÿåˆ—çš„å®ç°ç¤ºä¾‹**

```java

@Service
public class CacheUpdateService {

    @Autowired
    private DatabaseService databaseService;
    @Autowired
    private MessageQueueService messageQueueService;

    public void updateDataAndNotifyCache(String key, Object value) {
        // 1. æ›´æ–°æ•°æ®åº“
        databaseService.update(key, value);
        // 2. å‘é€ç¼“å­˜åˆ é™¤æ¶ˆæ¯ æ³¨æ„è¦åœ¨äº‹åŠ¡æäº¤åå‘é€
        // è¿™é‡Œä½¿ç”¨ Spring çš„äº‹åŠ¡ç®¡ç†å™¨æ¥ç¡®ä¿åœ¨äº‹åŠ¡æäº¤åå‘é€æ¶ˆæ¯
        TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronization() {
            @Override
            public void afterCommit() {
                messageQueueService.sendMessage("cache_delete_topic", key);
            }
        });
    }
}
```

**æ¶ˆè´¹è€…ç¤ºä¾‹ï¼š**

```java

@Component
public class CacheDeleteConsumer {
    @Resource
    private CacheService cacheService;

    @KafkaListener(topics = "cache_delete_topic")
    public void onMessage(String key) {
        // åˆ é™¤ç¼“å­˜ï¼Œå¹‚ç­‰æ“ä½œ
        cacheService.delete(key);
    }
}
```

## äº”ã€One-Light-Cache è§£å†³æ–¹æ¡ˆ

åœ¨ç†è§£äº†ä¸Šè¿°åˆ†å¸ƒå¼ç¼“å­˜çš„è®¾è®¡æ€è·¯åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…·ä½“çš„å®ç°æ–¹æ¡ˆï¼š`One-Light-Cache`ã€‚

`One-Light-Cache` æ˜¯ç¬”è€…å†™çš„ä¸€ä¸ª`è½»é‡çº§`çš„åˆ†å¸ƒå¼ç¼“å­˜å°ç»„ä»¶ï¼Œå®ƒæ•´åˆäº† `Caffeine` å’Œ `Redis` çš„ä¼˜åŠ¿ï¼Œå¹¶ç»“åˆ`æ¶ˆæ¯é˜Ÿåˆ—`
å®ç°äº†åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„`ç¼“å­˜ä¸€è‡´æ€§`ã€‚

å®Œæ•´ä»£ç å¯ä»¥å‚è€ƒ [One-Light-Cache](https://github.com/oneinstep/one-light-cache) é¡¹ç›®ã€‚

### 5.1 æ¡†æ¶ç‰¹æ€§

1. **ç»Ÿä¸€çš„ç¼“å­˜ç®¡ç†**

    - é›†æˆæœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰å’Œåˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰
    - ç»Ÿä¸€çš„ API æ¥å£
    - é›†æˆ `Aviator` è¡¨è¾¾å¼ï¼Œæ”¯æŒå¤æ‚çš„ç¼“å­˜åŠ è½½é€»è¾‘ã€‚
    - é›†æˆ `Spring Boot` é…ç½®ï¼Œæ”¯æŒ`é…ç½®åŒ–`ç®¡ç†ç¼“å­˜ã€‚

2. **åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¿è¯**

    - æ”¯æŒå¤šç§æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRedis/RocketMQ/Kafkaï¼‰é€šçŸ¥ç¼“å­˜æ›´æ–°
    - `åˆ†å¸ƒå¼é”`é˜²æ­¢ç¼“å­˜å‡»ç©¿ä»¥åŠåè°ƒç¼“å­˜ä¸€è‡´æ€§
    - æœ€ç»ˆä¸€è‡´æ€§ä¿è¯

3. **ç¼“å­˜é˜²æŠ¤**

    - å†…ç½®é˜²æ­¢ç¼“å­˜`å‡»ç©¿ã€é›ªå´©ã€ç©¿é€`çš„æœºåˆ¶

4. **ç›‘æ§ç»Ÿè®¡**

    - æ”¯æŒç¼“å­˜å‘½ä¸­ç‡ç­‰ä¸€äº›`ç»Ÿè®¡`

### 5.2 ä½¿ç”¨ç¤ºä¾‹

#### 5.2.1. **åŸºç¡€é…ç½®**

```yaml
light:
  cache:
    # ç¼“å­˜é…ç½® å¯é…ç½®å¤šä¸ªç¼“å­˜
    cache-configs:
      # æµ‹è¯•ç”¨æˆ·ç¼“å­˜
      - cacheName: test-user-cache
        # åˆå§‹ç¼“å­˜æ•°é‡
        initial-capacity: 20
        # æœ€å¤§ç¼“å­˜æ•°é‡
        maximum-size: 100
        # 5 ç§’åè¿‡æœŸ
        expire-after-write: 5000
        # ç¼“å­˜åŠ è½½è¡¨è¾¾å¼ ä½¿ç”¨ Aviator è¡¨è¾¾å¼
        load-cache-expression: getUserById(key)
        # åŠ è½½ç¼“å­˜ç­‰å¾…é”è¶…æ—¶æ—¶é—´ è¶…è¿‡è¯¥æ—¶é—´åï¼Œç¼“å­˜åŠ è½½å¤±è´¥ï¼Œå°†è®¾ç½®nullå€¼
        load-cache-wait-lock-timeout: 3000
        # è·å–æ•°æ®è¶…æ—¶æ—¶é—´
        fetch-data-timeout: 6000
        # mq ä¸»é¢˜
        mq-topic: user_data_change
        # mq ç±»å‹ï¼Œé»˜è®¤ä½¿ç”¨ RocketMQ
        mq-type: RocketMQ
    # æ¶ˆè´¹æ•°æ®å˜æ›´æ¶ˆæ¯çš„æ¶ˆè´¹è€…ç»„
    consumer-group: cache-consumer-group
    # RocketMQ NameServer åœ°å€ï¼Œå¦‚æœä½¿ç”¨ RocketMQ ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œåˆ™éœ€è¦é…ç½®
    rocketmq-name-server: localhost:9876
    # Kafka æœåŠ¡å™¨åœ°å€ï¼Œå¦‚æœä½¿ç”¨ Kafka ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œåˆ™éœ€è¦é…ç½®
    # kafka-bootstrap-servers: localhost:9092
```

#### 5.2.2. **ä»£ç ç¤ºä¾‹**

```java
// åˆ›å»ºç¼“å­˜
LightCacheManager .

<UserDTO> newCacheBuilder()
    .

cacheName("test-user-cache")
    .

initialCapacity(20)
    .

maximumSize(100)
    .

expireAfterWrite(5000)
// å¯ä»¥é€šè¿‡ Function å‡½æ•°æˆ–è€… Aviator è¡¨è¾¾å¼å®šä¹‰ç¼“å­˜åŠ è½½æ–¹å¼
    .

fetcher(userId ->UserDTO.

builder().

userId(userId).

userName("user-"+userId).

build())
        // .loadCacheExpression("getUserById(userId)")
        .

loadCacheWaitLockTimeout(3000)
    .

fetchDataTimeout(6000)
    .

mqTopic("user_data_change")
    .

mqType(MQType.ROCKETMQ)
    .

buildAndRegister();

// ä½¿ç”¨ç¼“å­˜
LightCache<UserDTO> cache = cacheManager.getCache("test-user-cache");
UserDTO user = cache.get("1");
```

### 5.3 åŸç†å’Œå…³é”®ä»£ç 

#### 5.3.1 æ•´ä½“æ¶æ„

- åˆ†å±‚è®¾è®¡
    - é‡‡ç”¨ä¸‰å±‚ç¼“å­˜æ¶æ„ï¼šåº”ç”¨å±‚ -> æœ¬åœ°ç¼“å­˜(Caffeine) -> åˆ†å¸ƒå¼ç¼“å­˜(Redis)ï¼Œé€šè¿‡å¤šçº§ç¼“å­˜ç­–ç•¥ä¼˜åŒ–è®¿é—®æ€§èƒ½ã€‚
- ä¸€è‡´æ€§ä¿è¯
    - ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRedis/RocketMQ/Kafkaï¼‰å®ç°å¤šèŠ‚ç‚¹é—´çš„ç¼“å­˜åŒæ­¥ï¼Œä¿è¯åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§ã€‚
- æ•°æ®æµè½¬
    - è¯»å–è·¯å¾„ï¼šä¼˜å…ˆæŸ¥æœ¬åœ°ç¼“å­˜ï¼Œæœªå‘½ä¸­åˆ™æŸ¥Redisï¼Œå†æœªå‘½ä¸­åˆ™é€šè¿‡åˆ†å¸ƒå¼é”åŠ è½½æ•°æ®æºã€‚
    - æ›´æ–°è·¯å¾„ï¼šæ›´æ–°æ•°æ®åé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—é€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹åˆ é™¤æœ¬åœ°ç¼“å­˜ï¼Œç”±æŠ¢åˆ°é”çš„èŠ‚ç‚¹è´Ÿè´£æ›´æ–°Redisã€‚
- é«˜å¯ç”¨è®¾è®¡
    - é€šè¿‡åˆ†å¸ƒå¼é”é¿å…å¹¶å‘åŠ è½½ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¿è¯å¯é é€šçŸ¥ï¼Œå¤šçº§ç¼“å­˜ç¡®ä¿ç³»ç»Ÿé«˜å¯ç”¨ã€‚
      è¿™ç§æ¶æ„è®¾è®¡åœ¨ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„åŒæ—¶ï¼Œé€šè¿‡å¤šçº§ç¼“å­˜å’Œæ¶ˆæ¯é˜Ÿåˆ—å®ç°äº†é«˜æ€§èƒ½å’Œé«˜å¯ç”¨æ€§ï¼Œé€‚åˆåˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ç¼“å­˜åº”ç”¨åœºæ™¯ã€‚

```mermaid
graph TD
    A[åº”ç”¨å±‚] --> B
    B --> C
    C --> D
    E --æŠ¢åˆ°é”çš„é‚£ä¸ªèŠ‚ç‚¹æ›´æ–°Redis--> D
    E --æ‰€æœ‰èŠ‚ç‚¹åˆ é™¤æœ¬åœ°ç¼“å­˜--> C
    
    subgraph ç¼“å­˜ç®¡ç†
    B[LightCacheManager]
    C[æœ¬åœ°ç¼“å­˜<br/>Caffeine]
    D[åˆ†å¸ƒå¼ç¼“å­˜<br/>Redis]
    end
    
    subgraph ä¸€è‡´æ€§é€šçŸ¥
    E[æ¶ˆæ¯é˜Ÿåˆ—<br/>Redis/RocketMQ/Kafka]
    end
```

#### 5.3.2 æ•°æ®è¯»å–æµç¨‹

```mermaid
sequenceDiagram
    participant App as åº”ç”¨
    participant Local as æœ¬åœ°ç¼“å­˜
    participant Redis as Redisç¼“å­˜
    participant Lock as åˆ†å¸ƒå¼é”
    participant DB as æ•°æ®æº
    
    App->>Local: 1. æŸ¥è¯¢æœ¬åœ°ç¼“å­˜
    alt æœ¬åœ°ç¼“å­˜å‘½ä¸­
        Local-->>App: è¿”å›æ•°æ®
    else æœ¬åœ°ç¼“å­˜æœªå‘½ä¸­
        Local->>Redis: 2. æŸ¥è¯¢Redis
        alt Rediså‘½ä¸­
            Redis-->>Local: 3a. æ›´æ–°æœ¬åœ°ç¼“å­˜
            Local-->>App: è¿”å›æ•°æ®
        else Redisæœªå‘½ä¸­
            Redis->>Lock: 3b. è·å–åˆ†å¸ƒå¼é”
            Lock->>DB: 4. æŸ¥è¯¢æ•°æ®æº
            DB-->>Redis: 5. å†™å…¥Redis
            Redis-->>Local: 6. æ›´æ–°æœ¬åœ°ç¼“å­˜
            Local-->>App: è¿”å›æ•°æ®
        end
    end
```

#### 5.3.3 å…³é”®å®ç°

**æ ¸å¿ƒç±»å›¾ï¼š**

```mermaid
classDiagram
    class LightCacheManager {
        -ALL_CACHE: Map
        -CACHE_CONSUMER: Map
        +getInstance() LightCacheManager
        +getCache(name) LightCache
        +registerCache(name, cache) void
        +registerConsumer(topic, consumer) void
    }

    class LightCache {
        -cacheName: String
        -redissonClient: RedissonClient
        +get(key) Object
        +invalidate(key) void
        +refreshOnMsg(key, isDelete) void
    }

    class AbsDataChangeConsumer {
        #topic: String
        #isRunning: boolean
        +consumeMsg(message) void
        #doConsume(message)*
    }

    class RocketMQDataChangeConsumer {
        -consumer: DefaultMQPushConsumer
        +doConsume(message) void
        +start() void
        +shutdown() void
    }

    class KafkaDataChangeConsumer {
        -consumer: KafkaConsumer
        +doConsume(message) void
        +start() void
        +shutdown() void
    }

    LightCacheManager "1" *-- "*" LightCache : manages
    LightCacheManager "1" *-- "*" AbsDataChangeConsumer : manages
    AbsDataChangeConsumer <|-- RocketMQDataChangeConsumer : extends
    AbsDataChangeConsumer <|-- KafkaDataChangeConsumer : extends
    LightCache ..> AbsDataChangeConsumer : notifies

```

5.3.3.1.**ç¼“å­˜ç®¡ç†å™¨**

é‡‡ç”¨å•ä¾‹æ¨¡å¼ç®¡ç†å…¨å±€ç¼“å­˜å®ä¾‹ã€‚

```java
public class LightCacheManager {
    // ç¼“å­˜å®¹å™¨
    private static final Map<String, LightCache<?>> ALL_CACHE = new ConcurrentHashMap<>();

    // ç¼“å­˜æ¶ˆè´¹è€…
    private static final Map<String, AbsDataChangeConsumer> CACHE_CONSUMER = new ConcurrentHashMap<>();

    // å•ä¾‹æ¨¡å¼
    private static volatile LightCacheManager instance;

    public static LightCacheManager getInstance() {
        // ...
        return instance;
    }
}
```

5.3.3.2.**ç¼“å­˜æ„å»ºå™¨**

ä½¿ç”¨å»ºé€ è€…æ¨¡å¼æä¾›æµå¼APIåˆ›å»ºç¼“å­˜ï¼Œæ”¯æŒçµæ´»é…ç½®ç¼“å­˜å‚æ•°ï¼ˆå¦‚è¿‡æœŸæ—¶é—´ã€å®¹é‡ç­‰ï¼‰å’Œæ¶ˆæ¯é˜Ÿåˆ—é€‰é¡¹ã€‚

```mermaid
classDiagram
    class CacheBuilder {
        +String cacheName
        +int initialCapacity
        +long maximumSize
        +long expireAfterWrite
        +Function<String, T> fetcher
        +String mqTopic
        +MQType mqType
        +buildAndRegister() void
    }
    
    class LightCache {
        -String cacheName
        -LoadingCache<String, V> caffeine
        -RedissonClient redissonClient
        -CacheMetrics metrics
        +get(String key) V
        +invalidate(String key) void
    }
    
    CacheBuilder ..> LightCache : creates
```

5.3.3.3.**ç¼“å­˜æ›´æ–°æœºåˆ¶**

é‡‡ç”¨å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†å‘é€æ¶ˆæ¯ï¼Œæœ€ååˆ é™¤ç¼“å­˜çš„æ›´æ–°ç­–ç•¥ï¼Œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ç¼“å­˜ä¸€è‡´æ€§ã€‚

```mermaid
sequenceDiagram
    participant App as åº”ç”¨
    participant DB as æ•°æ®åº“
    participant MQ as æ¶ˆæ¯é˜Ÿåˆ—
    participant Consumer as æ¶ˆè´¹è€…
    participant Cache as ç¼“å­˜
    
    App->>DB: 1. æ›´æ–°æ•°æ®åº“
    App->>MQ: 2. å‘é€ç¼“å­˜æ›´æ–°æ¶ˆæ¯
    MQ->>Consumer: 3. æ¶ˆè´¹æ¶ˆæ¯
    Consumer->>Cache: 4. åˆ é™¤ç¼“å­˜
```

5.3.3.4.**æ¶ˆæ¯æ¶ˆè´¹è€…å®ç°**

æŠ½è±¡æ¶ˆè´¹è€…åŸºç±»å¤„ç†æ¶ˆæ¯è§£æå’Œç¼“å­˜æ›´æ–°é€»è¾‘ï¼Œæ”¯æŒ UPDATE å’Œ DELETE ç­‰æ“ä½œç±»å‹ã€‚

```java
public abstract class AbsDataChangeConsumer {
    protected final String topic;
    protected volatile boolean isRunning = true;

    public final void consumeMsg(String message) {
        if (!isRunning) {
            return;
        }

        DataChangeMsg dataChangeMsg = JSON.parseObject(message, DataChangeMsg.class);
        String dataName = dataChangeMsg.getDataName();
        String dataId = dataChangeMsg.getDataId();

        LightCache<?> cache = LightCacheManager.getInstance().getCache(dataName);

        switch (dataChangeMsg.getType()) {
            case UPDATE:
                cache.refreshOnMsg(dataId, false);
                break;
            case DELETE:
                cache.refreshOnMsg(dataId, true);
                break;
        }
    }
}
```

5.3.3.5.**ç¼“å­˜é˜²æŠ¤æœºåˆ¶**

ç»“åˆåˆ†å¸ƒå¼é”å’ŒåŒé‡æ£€æŸ¥æœºåˆ¶é˜²æ­¢ç¼“å­˜å‡»ç©¿ï¼Œé€šè¿‡ç­‰å¾…è¶…æ—¶å’Œç©ºå€¼ç¼“å­˜é˜²æ­¢ç¼“å­˜ç©¿é€ã€‚

```mermaid
graph TD
    A[ç¼“å­˜è¯·æ±‚] --> B{æ˜¯å¦å­˜åœ¨?}
    B -->|æ˜¯| C[è¿”å›æ•°æ®]
    B -->|å¦| D{è·å–é”?}
    D -->|æ˜¯| E[æŸ¥è¯¢æ•°æ®æº]
    D -->|å¦| F[ç­‰å¾…è·å–é”]
    E --> G[æ›´æ–°ç¼“å­˜]
    G --> C
    F --> B
```

## å…­ã€æ€»ç»“

### 6.1 One-Light-Cache è®¾è®¡æ€è·¯æ€»ç»“

1. **å¤šçº§ç¼“å­˜æ¶æ„**

    - åˆ©ç”¨ Caffeine ä½œä¸ºæœ¬åœ°ç¼“å­˜ï¼Œæä¾›é«˜æ€§èƒ½çš„æœ¬åœ°æ•°æ®è®¿é—®
    - ä½¿ç”¨ Redis ä½œä¸ºåˆ†å¸ƒå¼ç¼“å­˜ï¼Œè§£å†³åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ•°æ®å…±äº«é—®é¢˜
    - é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å®ç°ç¼“å­˜ä¸€è‡´æ€§ï¼Œä¿è¯å¤šèŠ‚ç‚¹æ•°æ®åŒæ­¥

2. **å…³é”®æŠ€æœ¯é€‰å‹**

    - Caffeineï¼šé«˜æ€§èƒ½çš„æœ¬åœ°ç¼“å­˜å®ç°
    - Redisï¼šå¯é çš„åˆ†å¸ƒå¼ç¼“å­˜æ–¹æ¡ˆ
    - æ¶ˆæ¯é˜Ÿåˆ—ï¼šæ”¯æŒå¤šç§é€‰é¡¹ï¼ˆRedis/RocketMQ/Kafkaï¼‰ï¼Œå®ç°æœ€ç»ˆä¸€è‡´æ€§

3. **æ ¸å¿ƒç‰¹æ€§**

    - ç»Ÿä¸€çš„ç¼“å­˜ç®¡ç†æ¥å£
    - çµæ´»çš„é…ç½®æ–¹å¼
    - å®Œå–„çš„ç¼“å­˜é˜²æŠ¤æœºåˆ¶
    - å¯é çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¿è¯

### 6.2 ç¼“å­˜ç³»ç»Ÿå®è·µå»ºè®®

1. **ç¼“å­˜ç­–ç•¥é€‰æ‹©**

    - æ ¹æ®æ•°æ®ç‰¹æ€§é€‰æ‹©åˆé€‚çš„ç¼“å­˜è¿‡æœŸæ—¶é—´
    - å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜çš„æ•°æ®ï¼Œæ…ç”¨ç¼“å­˜
    - åˆç†è®¾ç½®ç¼“å­˜å®¹é‡ï¼Œé¿å…å†…å­˜æº¢å‡º

2. **ä¸€è‡´æ€§è€ƒè™‘**

    - åœ¨ç»å¤§å¤šæ•°åœºæ™¯ä¸‹ï¼Œæœ€ç»ˆä¸€è‡´æ€§å·²ç»è¶³å¤Ÿ
    - å¯¹äºå¼ºä¸€è‡´æ€§è¦æ±‚çš„åœºæ™¯ï¼Œå»ºè®®ç›´æ¥æŸ¥è¯¢æ•°æ®æº
    - ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—æ—¶æ³¨æ„æ¶ˆæ¯çš„å¯é æ€§æŠ•é€’

3. **æ€§èƒ½ä¼˜åŒ–**

    - åˆç†ä½¿ç”¨é¢„çƒ­æœºåˆ¶ï¼Œé¿å…å†·å¯åŠ¨
    - ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡ï¼ŒåŠæ—¶è°ƒæ•´ç¼“å­˜ç­–ç•¥
    - æ³¨æ„ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©çš„é˜²æŠ¤

ç¼“å­˜ç³»ç»Ÿçš„è®¾è®¡å’Œå®ç°æ˜¯ä¸€ä¸ªå¤æ‚çš„å·¥ç¨‹ï¼Œéœ€è¦åœ¨æ€§èƒ½ã€ä¸€è‡´æ€§ã€å¯ç”¨æ€§ç­‰å¤šä¸ªç»´åº¦ä¹‹é—´åšå‡ºæƒè¡¡ã€‚`One-Light-Cache`
åªæ˜¯æä¾›äº†ä¸€ä¸ªåŸºç¡€çš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¿˜éœ€è¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯åšå‡ºé€‚å½“çš„è°ƒæ•´å’Œä¼˜åŒ–ã€‚è¿™é‡Œåªå¸Œæœ›è¿™ä¸ªé¡¹ç›®èƒ½ä¸ºå¤§å®¶æä¾›ä¸€äº›å‚è€ƒå’Œå¯å‘ã€‚

#### æ¨èé˜…è¯»

å…³äºç¼“å­˜ç›¸å…³å¼€æºæ¡†æ¶å’ŒæŠ€æœ¯æ–‡ç« ï¼Œå¤§å®¶å¯ä»¥çœ‹çœ‹ï¼š

- äº¬ä¸œçš„ [HotKey](https://gitee.com/jd-platform-opensource/hotkey.git)
    - å¯ä»¥å®ç°`çƒ­ç‚¹æ•°æ®`çš„æ¯«ç§’çº§ç²¾å‡†`æ¢æµ‹`å’Œè‡ªåŠ¨æœ¬åœ°ç¼“å­˜ã€‚
    - ä¸»è¦åŸç†ï¼š`Worker`æœºå™¨ä¸`Client`æœºå™¨åˆ©ç”¨`Netty`å»ºç«‹ç½‘ç»œè¿æ¥ï¼Œ`Client`æœºå™¨å°†æ•°æ®`ä¸ŠæŠ¥`ç»™`Worker`æœºå™¨ï¼Œ`Worker`æœºå™¨è¿›è¡Œæ•°æ®
      `æ±‡æ€»`è®¡ç®—ï¼Œç„¶åå°†çƒ­ç‚¹æ•°æ®å†`æ¨é€`åˆ°`Client`æœºå™¨è¿›è¡Œ`æœ¬åœ°ç¼“å­˜`ã€‚

- æœ‰èµçš„é€æ˜å¤šçº§ç¼“å­˜è§£å†³æ–¹æ¡ˆï¼ˆTMCï¼‰
    - ç›®å‰æ²¡å¼€æºï¼Œä½†æ˜¯å¯ä»¥å‚è€ƒå…¶ [è®¾è®¡æ€è·¯](https://tech.youzan.com/tmc/)ã€‚
    - ä¸»è¦åŸç†æ˜¯å¯¹åŸç”Ÿ`jedis`åŒ…çš„`JedisPool`å’Œ`Jedis`ç±»åšäº†æ”¹é€ ï¼Œåœ¨`JedisPool`åˆå§‹åŒ–è¿‡ç¨‹ä¸­é›†æˆ`TMC`çš„`çƒ­ç‚¹å‘ç°`+`æœ¬åœ°ç¼“å­˜`
      åŠŸèƒ½ã€‚

- æºç¨‹çš„æŠ€æœ¯æ–‡ç« 
    - [æºç¨‹æœ€ç»ˆä¸€è‡´å’Œå¼ºä¸€è‡´æ€§ç¼“å­˜å®è·µ](https://mp.weixin.qq.com/s/E-chAZyHtaZOdA19mW59-Q)
    - [æºç¨‹ç™¾äº¿çº§ç¼“å­˜ç³»ç»Ÿæ¢ç´¢ä¹‹è·¯â€”â€”æœ¬åœ°ç¼“å­˜ç»“æ„é€‰å‹ä¸å†…å­˜å‹ç¼©](https://mp.weixin.qq.com/s/rMY_BP5bd-o9YkgXo1ySeg)

---

æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œ**å­å®‰èŠä»£ç **â€ï¼Œä¸€èµ·æ¢è®¨æŠ€æœ¯ã€‚
<div style="text-align: center;">
    <img src="https://mp-img-1300842660.cos.ap-guangzhou.myqcloud.com/1725553610603-faeaaec6-b1b6-4f03-b4e2-7ddbf6fbccdf.jpg" style="width: 100px;" alt="">
</div>